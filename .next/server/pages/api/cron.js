"use strict";(()=>{var e={};e.id=803,e.ids=[803],e.modules={5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6762:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},3816:(e,t,s)=>{s.r(t),s.d(t,{config:()=>A,default:()=>y,routeModule:()=>I});var n={};s.r(n),s.d(n,{default:()=>E});var r=s(9947),o=s(2706),a=s(6762);let i=require("@supabase/supabase-js"),l=process.env.SUPABASE_URL||"https://tqwxogsgenszcdglgxvn.supabase.co",c=process.env.SUPABASE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxd3hvZ3NnZW5zemNkZ2xneHZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MzUzMjcsImV4cCI6MjA2ODExMTMyN30.fRhzqyokOXqUXoLiKkhg4h8zKLu2daD351mqBvuOatU",u=(0,i.createClient)(l,c),h="https://api.neynar.com/v2/farcaster",d={accept:"application/json","x-api-key":process.env.NEYNAR_API_KEY};async function f(){try{let e=await fetch(`${h}/channels/trending`,{headers:d});if(!e.ok)return console.error("Failed to fetch trending channels:",e.statusText),["memes","crypto","ask","tech","music","art","founders","gaming"];let t=await e.json();return t.channels?.map(e=>e.id)||["memes","crypto","ask","tech","music"]}catch(e){return console.error("Error fetching trending channels:",e),["memes","crypto","ask","tech","music","art","founders","gaming"]}}async function m(e,t=100){try{let s=await fetch(`${h}/feed/channels?channel_ids=${e}&limit=${t}&with_recasts=false`,{headers:d});if(!s.ok)return console.error(`Failed to fetch casts for channel ${e}:`,s.statusText),[];return(await s.json()).casts||[]}catch(t){return console.error(`Error fetching casts for channel ${e}:`,t),[]}}let p=require("dayjs");var g=s.n(p);let P=require("dayjs/plugin/utc");var k=s.n(P);async function E(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method Not Allowed"});let s=e.headers.authorization||"",n=process.env.CRON_SECRET;if(n&&s!==`Bearer ${n}`)return t.status(401).json({error:"Unauthorized"});try{console.log("Starting daily snapshot generation...");let e=g()().utc().format("YYYY-MM-DD"),{data:s}=await u.from("snapshots").select("id").eq("date",e).single();if(s)return console.log(`Snapshot already exists for ${e}`),t.status(200).json({message:`Snapshot already exists for ${e}`,date:e});let n=await f();console.log(`Processing ${n.length} channels:`,n);let r=[],o=null,a=-1;for(let e of n.slice(0,8))try{console.log(`Processing channel: ${e}`);let t=await m(e,50);if(0===t.length){console.log(`No casts found for channel: ${e}`);continue}let s=null,n=-1;for(let r of t){let t=r.reactions?.likes?.length||0;t>n&&(n=t,s=r),t>a&&(a=t,o={...r,channel:{id:e}})}r.push({channel:e,totalCasts:t.length,mostLikedCast:s}),console.log(`Channel ${e}: ${t.length} casts, best: ${n} likes`),await new Promise(e=>setTimeout(e,100))}catch(t){console.error(`Error processing channel ${e}:`,t);continue}r.sort((e,t)=>t.totalCasts-e.totalCasts);let i={date:e,top_channels:r.map(e=>({channel:e.channel,totalCasts:e.totalCasts,mostLikedCast:e.mostLikedCast?{hash:e.mostLikedCast.hash,text:e.mostLikedCast.text,author:{username:e.mostLikedCast.author.username},reactions:{likes:e.mostLikedCast.reactions.likes||[]}}:null})),most_liked_cast:o?{hash:o.hash,text:o.text,author:{username:o.author.username},reactions:{likes:o.reactions.likes||[]},channel:o.channel?.id}:null},{error:l}=await u.from("snapshots").insert([i]);if(l)return console.error("Error inserting snapshot:",l),t.status(500).json({error:"Failed to store snapshot",details:l.message});let c=g()().utc().subtract(7,"day").format("YYYY-MM-DD"),{error:h}=await u.from("snapshots").delete().lt("date",c);return h&&console.error("Error cleaning up old snapshots:",h),console.log(`Snapshot stored successfully for ${e}`),console.log(`Processed ${r.length} channels, global most liked: ${a} likes`),t.status(200).json({success:!0,date:e,channelsProcessed:r.length,globalMostLikedLikes:a})}catch(e){return console.error("Error in cron job:",e),t.status(500).json({error:"Internal server error",message:e instanceof Error?e.message:"Unknown error"})}}g().extend(k());let y=(0,a.M)(n,"default"),A=(0,a.M)(n,"config"),I=new r.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/cron",pathname:"/api/cron",bundlePath:"",filename:""},userland:n})},2706:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return s}});var s=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9947:(e,t,s)=>{e.exports=s(5600)}};var t=require("../../webpack-api-runtime.js");t.C(e);var s=t(t.s=3816);module.exports=s})();